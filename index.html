<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SADAO MED-TECH 2026</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&family=Orbitron:wght@500;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root { --primary: #00f2ff; --secondary: #00ff88; --bg-dark: #050a10; --panel-bg: rgba(10, 20, 35, 0.95); }
        
        body { 
            font-family: 'Chakra Petch', sans-serif; 
            background-color: var(--bg-dark); 
            color: #e0e0e0; min-height: 100vh; padding-bottom: 60px; 
            background-image: 
                linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        /* --- SCI-FI LOADER --- */
        #sci-fi-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 10, 16, 0.95); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(15px);
        }
        .spinner-ring {
            width: 100px; height: 100px; border: 3px solid transparent;
            border-top: 3px solid var(--primary); border-right: 3px solid var(--secondary);
            border-radius: 50%; animation: spin 1s linear infinite;
            box-shadow: 0 0 15px var(--primary); margin-bottom: 20px;
        }
        .spinner-core {
            width: 60px; height: 60px; background: rgba(0, 242, 255, 0.1);
            border-radius: 50%; position: absolute; animation: pulse 1.5s ease-in-out infinite;
        }
        .loading-text { font-family: 'Orbitron'; color: var(--primary); letter-spacing: 2px; margin-top: 10px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(0.8); opacity: 0.5; } }

        /* --- UI Styles --- */
        .logo-anim { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%,100% { transform: translateY(0); filter: drop-shadow(0 0 10px var(--primary)); } 50% { transform: translateY(-5px); filter: drop-shadow(0 0 20px var(--secondary)); } }

        .tech-panel { background: var(--panel-bg); border: 1px solid rgba(0,242,255,0.3); border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.7); }
        .neon-text { color: var(--primary); text-shadow: 0 0 10px rgba(0,242,255,0.6); font-family: 'Orbitron'; }
        
        .btn-cyber { background: rgba(0,242,255,0.1); border: 1px solid var(--primary); color: var(--primary); transition: 0.3s; text-transform: uppercase; }
        .btn-cyber:hover { background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary); }
        
        /* Custom SweetAlert Theme (Dark) */
        div:where(.swal2-container) div:where(.swal2-popup) { background: #0a1423 !important; border: 1px solid var(--primary); color: #fff; }
        .swal2-title { color: var(--primary) !important; font-family: 'Orbitron' !important; }
        
        .cat-card { cursor: pointer; transition: 0.2s; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); }
        .cat-card:hover { border-color: var(--secondary); background: rgba(0,255,136,0.1); transform: translateY(-5px); box-shadow: 0 0 15px rgba(0,255,136,0.2); }
        
        .card-player { border-left: 4px solid #555; margin-bottom: 10px; padding: 12px; background: rgba(255,255,255,0.03); transition: 0.3s; position: relative; }
        .card-player.active { border-left-color: var(--secondary); background: linear-gradient(90deg, rgba(0,255,136,0.1), transparent); }
        .card-player.voted-by-me { border-right: 4px solid var(--primary); }
        
        .seq-num { font-family: 'Orbitron'; font-size: 1.2rem; color: #666; width: 35px; text-align: center; font-weight: bold; }
        .active .seq-num { color: var(--secondary); text-shadow: 0 0 10px var(--secondary); }
        
        .voter-tag { display: inline-block; background: #222; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; color: #aaa; margin-right: 3px; border: 1px solid #444; }
        .voter-tag.me { border-color: var(--primary); color: var(--primary); }
        
        .input-cyber { background: #111; border: 1px solid #444; color: #fff; width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .input-cyber:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 10px rgba(0,242,255,0.2); }
        
        .group-title { color: var(--secondary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; margin: 20px 0 10px 0; font-family: 'Orbitron'; letter-spacing: 1px; }

        #login-container { height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 1000; position: relative; }
        #app-container { display: none; }
        .dev-credit { position: fixed; bottom: 5px; width: 100%; text-align: center; font-size: 0.7rem; color: rgba(255,255,255,0.2); pointer-events: none; }
        
        @media print { body * { visibility: hidden; } #print-area, #print-area * { visibility: visible; } #print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; padding: 20px; } }
    </style>
</head>
<body>

    <div id="sci-fi-loader">
        <div class="spinner-core"></div>
        <div class="spinner-ring"></div>
        <h4 class="loading-text">INITIALIZING SYSTEM...</h4>
        <small class="text-muted" style="font-family: 'Chakra Petch';">Connecting to Database</small>
    </div>

    <div id="login-container">
        <div class="tech-panel p-5 text-center" style="max-width: 400px; width: 90%;">
            <img src="https://raw.githubusercontent.com/PINGJUPPY/SadaoContest/refs/heads/main/SDH%20LOGO.png" class="logo-anim" style="max-width:120px; margin-bottom:20px;">
            <h3 class="neon-text mb-4">ACCESS CONTROL</h3>
            <input id="user" class="input-cyber text-center" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å User">
            <input id="pass" type="password" class="input-cyber text-center" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Password">
            <button class="btn btn-cyber w-100 mt-3 fw-bold" onclick="doLogin()">LOGIN SYSTEM</button>
        </div>
    </div>

    <div id="app-container">
        <nav class="navbar navbar-dark bg-transparent border-bottom border-secondary mb-3 p-2">
            <div class="container-fluid">
                <span class="navbar-brand neon-text d-flex align-items-center" style="font-size:1rem;">
                    <img src="https://raw.githubusercontent.com/PINGJUPPY/SadaoContest/refs/heads/main/SDH%20LOGO.png" class="logo-anim me-2" style="height:35px;">
                    SADAO MED-TECH
                </span>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-secondary d-none d-md-block me-2" style="font-size:0.7rem;">Sync: <span id="update-time">--:--</span></small>
                    <small class="text-info d-none d-md-block me-2" id="user-display"></small>
                    <button class="btn btn-sm btn-outline-light" onclick="printReport()"><i class="fa-solid fa-print"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="doLogout()"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </nav>

        <div id="admin-toolbar" class="container mb-3 d-none">
            <div class="d-flex justify-content-center gap-2 flex-wrap">
                <button class="btn btn-sm btn-outline-info" onclick="addNewContestant()"><i class="fa-solid fa-plus"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                <button class="btn btn-sm btn-outline-success" onclick="addJudge()"><i class="fa-solid fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</button>
                <button class="btn btn-sm btn-outline-warning" onclick="toggleEditMode()"><i class="fa-solid fa-sort"></i> ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</button>
            </div>
        </div>

        <section id="view-dashboard" class="container">
            <div id="dashboard-content"></div>
        </section>

        <section id="view-list" class="container" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-sm btn-outline-light" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i> BACK</button>
                <h6 class="neon-text m-0 text-truncate ms-2" id="cat-title"></h6>
                <div style="width:30px"></div>
            </div>
            <div id="contestant-container"></div>
        </section>

        <section id="view-rank" class="container mt-4 mb-5">
            <div class="tech-panel p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="neon-text m-0"><i class="fa-solid fa-chart-simple"></i> RANKING (AVG)</h6>
                    <select id="rank-level-filter" class="form-select form-select-sm bg-dark text-light w-auto" style="font-size:0.7rem" onchange="updateRank()">
                        <option value="All">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                        <option value="Hospital">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
                        <option value="HPH">‡∏£‡∏û.‡∏™‡∏ï.</option>
                        <option value="DHO">‡∏™‡∏™‡∏≠.</option>
                    </select>
                </div>
                <table class="table table-dark table-sm bg-transparent" style="font-size:0.8rem">
                    <thead><tr class="text-info"><th>#</th><th>TEAM</th><th class="text-end">SCORE</th></tr></thead>
                    <tbody id="rank-body"></tbody>
                </table>
            </div>
        </section>
    </div>

    <div class="dev-credit">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏ô‡∏≤‡∏¢‡∏ó‡∏®‡∏û‡∏£ ‡∏Ñ‡∏á‡∏™‡∏∏‡∏Ç‡∏ô‡∏¥‡∏£‡∏±‡∏ô‡∏î‡∏£‡πå ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏ú‡∏ô‡πÑ‡∏ó‡∏¢</div>
    <div id="print-area" style="display:none;"></div>

    <script>
        // üî¥üî¥ URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî¥üî¥
        const API_URL = "https://script.google.com/macros/s/AKfycbyGtY1FBwTvk0ng7eOcGJ_cs9mZt-6jC9WoOAWhp1d6YHSTpd3HDJImdae3dFxMvfRv7Q/exec";

        const CATS = {
            'Oral_Research': { label: 'Oral: ‡∏ß‡∏¥‡∏à‡∏±‡∏¢', group: 'Oral' },
            'Oral_R2R': { label: 'Oral: R2R', group: 'Oral' },
            'Oral_CQI_Clinic': { label: 'Oral: CQI (Clinic)', group: 'Oral' },
            'Oral_CQI_NonClinic': { label: 'Oral: CQI (Non-Clinic)', group: 'Oral' },
            'Poster_Research': { label: 'Poster: ‡∏ß‡∏¥‡∏à‡∏±‡∏¢', group: 'Poster' },
            'Poster_R2R': { label: 'Poster: R2R', group: 'Poster' },
            'Poster_Innovation': { label: 'Poster: ‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°', group: 'Poster' },
            'Photo_Service': { label: 'Photo: ‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', group: 'Photo' },
            'Photo_Community': { label: 'Photo: ‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô', group: 'Photo' },
            'ShortFilm': { label: '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏±‡πâ‡∏ô', group: 'Film' }
        };
        const LEVELS = ['Hospital', 'HPH', 'DHO']; 
        const LEVEL_LABELS = {'Hospital':'‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', 'HPH':'‡∏£‡∏û.‡∏™‡∏ï.', 'DHO':'‡∏™‡∏™‡∏≠.'};
        
        const CRITERIA = {
            'Oral_Research': [ {n:'‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ó‡∏µ‡πà‡∏°‡∏≤', m:15}, {n:'‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå', m:15}, {n:'‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏ß‡∏¥‡∏à‡∏±‡∏¢', m:15}, {n:'‡∏ú‡∏•/‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', m:15}, {n:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û', m:5}, {n:'‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå', m:10}, {n:'‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°', m:5}, {n:'‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå', m:20} ],
            'Default': [{n:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°', m:100}]
        };

        let currentUser = null, allData = [], allVotes = {}, currentCat = '', isEditMode = false, syncInterval = null, wakeLock = null;

        // --- Helper: Loader ---
        function showLoader(msg) {
            document.querySelector('.loading-text').innerText = msg || "PROCESSING...";
            document.getElementById('sci-fi-loader').style.display = 'flex';
        }
        function hideLoader() {
            document.getElementById('sci-fi-loader').style.display = 'none';
        }

        window.onload = () => {
            const saved = localStorage.getItem('sadao_user_v3');
            if(saved) { currentUser = JSON.parse(saved); bootSystem(); }
        };

        // Wake Lock
        async function requestWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {} }
        document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock(); });

        function doLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            showLoader("AUTHENTICATING...");
            fetch(`${API_URL}?action=login&u=${u}&p=${p}`).then(res=>res.json()).then(data=>{
                if(data.status==='success'){ 
                    currentUser=data.user; 
                    localStorage.setItem('sadao_user_v3',JSON.stringify(currentUser)); 
                    setTimeout(() => { bootSystem(); hideLoader(); }, 1000); // Fake delay for cool effect
                } else { hideLoader(); Swal.fire('Access Denied','Login Failed','error'); }
            }).catch(()=>hideLoader());
        }
        function doLogout() { localStorage.removeItem('sadao_user_v3'); location.reload(); }
        
        function bootSystem() {
            document.getElementById('login-container').style.display='none'; 
            document.getElementById('app-container').style.display='block';
            document.getElementById('user-display').innerText = currentUser.name;
            if(currentUser.role==='Admin') document.getElementById('admin-toolbar').classList.remove('d-none');
            
            requestWakeLock();
            fetchData();
            if(syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(() => { if(!isEditMode) fetchData(true); }, 5000);
        }

        async function fetchData(isAuto = false) {
            if(!isAuto) showLoader("SYNCING DATA...");
            try {
                const res = await fetch(`${API_URL}?action=getData`);
                const json = await res.json();
                allData = json.contestants || [];
                allVotes = json.votes || {}; 
                
                setupDashboard();
                updateRank();
                if(document.getElementById('view-list').style.display==='block') renderList();
                
                let now = new Date();
                document.getElementById('update-time').innerText = now.toTimeString().split(' ')[0];
                if(!isAuto) hideLoader();
            } catch(e) { if(!isAuto) hideLoader(); }
        }

        function setupDashboard() {
            const container = document.getElementById('dashboard-content'); container.innerHTML = '';
            const GROUPS = ['Oral', 'Poster', 'Photo', 'Film'];
            GROUPS.forEach(g => {
                let catsInGroup = Object.keys(CATS).filter(k => CATS[k].group === g);
                let visible = catsInGroup.filter(k => currentUser.role==='Admin' || currentUser.categories.includes(CATS[k].group));
                if(visible.length > 0) {
                    let html = `<div class="group-title">${g}</div><div class="row g-2">`;
                    visible.forEach(k => html += `<div class="col-6 col-md-4"><div class="tech-panel cat-card" onclick="openCat('${k}')"><div style="font-size:0.85rem">${CATS[k].label}</div></div></div>`);
                    container.innerHTML += html + `</div>`;
                }
            });
        }
        function openCat(k) { currentCat=k; document.getElementById('view-dashboard').style.display='none'; document.getElementById('view-list').style.display='block'; document.getElementById('cat-title').innerText=CATS[k].label; renderList(); }
        function goHome() { document.getElementById('view-list').style.display='none'; document.getElementById('view-dashboard').style.display='block'; fetchData(); }

        function renderList() {
            const cont = document.getElementById('contestant-container'); cont.innerHTML='';
            let list = allData.filter(r => r[3] === currentCat);
            if(list.length===0) { cont.innerHTML='<div class="text-center text-muted py-5">NO DATA</div>'; return; }
            
            list.forEach((r, idx) => {
                let id = r[0], active = r[5] === 'Active';
                let voters = allVotes[id] || [];
                let iVoted = voters.includes(currentUser.name);
                
                let votedHtml = '';
                if(voters.length > 0) {
                    votedHtml = `<div class="mt-1">`;
                    voters.forEach(v => { votedHtml += `<span class="voter-tag ${v===currentUser.name?'me':''}">${v===currentUser.name?'You':v}</span>`; });
                    votedHtml += `</div>`;
                }

                cont.innerHTML += `
                <div class="tech-panel card-player ${active?'active':''} ${iVoted?'voted-by-me':''}" data-id="${id}">
                    <div class="d-flex align-items-center">
                        <div class="drag-handle me-2 ${isEditMode?'':'d-none'}" style="cursor:move;color:var(--primary)">‚ò∞</div>
                        <div class="seq-num">${idx+1}</div> 
                        <div class="flex-grow-1 ps-2" style="overflow:hidden;">
                            ${active?'<span class="badge bg-success mb-1">ON STAGE</span>':''}
                            <div class="fw-bold text-truncate">${r[1]}</div>
                            <div class="small text-muted text-truncate">${r[2]}</div>
                            <span class="level-badge">${LEVEL_LABELS[r[7]]||r[7]}</span> <small class="text-info">${r[4]}</small>
                            ${votedHtml}
                        </div>
                        <button class="btn btn-sm ${iVoted?'btn-outline-secondary':'btn-cyber'} ms-2" onclick="openScore('${id}','${r[1]}')">
                            ${iVoted?'EDIT':'VOTE'}
                        </button>
                    </div>
                </div>`;
            });
            if(sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(cont, { handle: '.drag-handle', disabled: !isEditMode, onEnd: saveOrder });
        }

        // --- üü¢ FIX: Add New Contestant Function ---
        async function addNewContestant() {
            // Generate Options
            let catOpts = ''; 
            Object.keys(CATS).forEach(k => catOpts += `<option value="${k}">${CATS[k].label}</option>`);
            
            let lvOpts = ''; 
            LEVELS.forEach(l => lvOpts += `<option value="${l}">${LEVEL_LABELS[l]}</option>`);

            const { value: formValues } = await Swal.fire({
                title: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà',
                background: '#0a1423', color: '#fff',
                html: `
                    <input id="new-title" class="input-cyber" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ú‡∏•‡∏á‡∏≤‡∏ô">
                    <input id="new-contestant" class="input-cyber" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î / ‡∏ó‡∏µ‡∏°">
                    <input id="new-org" class="input-cyber" placeholder="‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (‡∏£‡∏û./‡∏£‡∏û.‡∏™‡∏ï.)">
                    <label class="d-block text-start small text-info mt-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <select id="new-cat" class="input-cyber">${catOpts}</select>
                    <label class="d-block text-start small text-info mt-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                    <select id="new-lv" class="input-cyber">${lvOpts}</select>
                `,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                confirmButtonColor: '#00f2ff',
                preConfirm: () => {
                    return {
                        title: document.getElementById('new-title').value,
                        contestant: document.getElementById('new-contestant').value,
                        org: document.getElementById('new-org').value,
                        cat: document.getElementById('new-cat').value,
                        level: document.getElementById('new-lv').value
                    }
                }
            });

            if (formValues && formValues.title) {
                showLoader("SAVING DATA...");
                fetch(`${API_URL}?action=addContestant&title=${formValues.title}&contestant=${formValues.contestant}&org=${formValues.org}&category=${formValues.cat}&level=${formValues.level}`)
                .then(response => {
                    hideLoader();
                    Swal.fire({icon:'success', title:'Success', text:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', background:'#0a1423', color:'#fff', timer:1500, showConfirmButton:false});
                    fetchData(true); // Refresh
                })
                .catch(err => {
                    hideLoader();
                    Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
                });
            }
        }

        async function addJudge() {
            const { value: form } = await Swal.fire({
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà', background:'#0a1423', color:'#fff',
                html: `
                    <input id="j-user" class="input-cyber" placeholder="Username">
                    <input id="j-pass" class="input-cyber" placeholder="Password">
                    <input id="j-name" class="input-cyber" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£">
                    <div class="text-start small text-muted mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡πÄ‡∏ä‡πà‡∏ô Oral,Poster)</div>
                    <input id="j-cats" class="input-cyber" value="Oral,Poster,Photo,Film">
                `,
                preConfirm: () => ({ u: document.getElementById('j-user').value, p: document.getElementById('j-pass').value, name: document.getElementById('j-name').value, cats: document.getElementById('j-cats').value })
            });
            if(form && form.u) {
                showLoader("CREATING USER...");
                fetch(`${API_URL}?action=addJudge&u=${form.u}&p=${form.p}&name=${form.name}&cats=${form.cats}`)
                .then(()=>{ hideLoader(); Swal.fire('Success','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß','success'); });
            }
        }

        async function openScore(id, title) {
            let list = CRITERIA[currentCat] || CRITERIA['Default'];
            let html = `<div id="sc-box">`;
            list.forEach((c,i)=> html+=`<div class="d-flex justify-content-between mb-2 align-items-center"><span class="small text-info text-start">${c.n} (${c.m})</span><input type="number" id="s${i}" class="input-cyber text-center" style="width:60px" min="0" max="${c.m}" oninput="if(value>${c.m})value=${c.m};calc()"></div>`);
            html += `</div><div class="text-end h5 text-primary mt-3">‡∏£‡∏ß‡∏°: <span id="sum">0</span></div>`;
            
            const {isConfirmed} = await Swal.fire({
                title: title, html: html, background:'#0a1423', color:'#fff', showCancelButton:true, confirmButtonText:'SUBMIT', confirmButtonColor:'#00f2ff',
                didOpen: calc 
            });

            if(isConfirmed) {
                let total=0, det="";
                list.forEach((c,i)=>{ let v=Number(document.getElementById(`s${i}`).value)||0; total+=v; det+=`[${c.n}:${v}]`; });
                showLoader("SENDING SCORE...");
                fetch(`${API_URL}?action=submitScore&id=${id}&judge=${currentUser.name}&score=${total}&detail=${det}`).then(()=>{ hideLoader(); Swal.fire({icon:'success',title:'Saved',timer:1000,showConfirmButton:false,background:'#0a1423',color:'#fff'}); fetchData(true); });
            }
        }
        window.calc = function() { let s=0; document.querySelectorAll('#sc-box input').forEach(i=>s+=Number(i.value)||0); document.getElementById('sum').innerText=s; }

        function updateRank() {
            const f = document.getElementById('rank-level-filter').value;
            const b = document.getElementById('rank-body'); b.innerHTML='';
            let d = [...allData].filter(r=>(f==='All'||r[7]===f)).sort((a,b)=>(b[6]||0)-(a[6]||0)).slice(0,5);
            d.forEach((r,i)=> b.innerHTML+=`<tr><td><span class="badge bg-dark border border-secondary">${i+1}</span></td><td><div class="text-truncate" style="max-width:180px">${r[1]}</div></td><td class="text-end text-primary fw-bold">${Number(r[6]).toFixed(2)}</td></tr>`);
        }
        function toggleEditMode() { isEditMode=!isEditMode; renderList(); }
        function saveOrder() { const ids = Array.from(document.querySelectorAll('.card-player')).map(e=>e.getAttribute('data-id')); fetch(`${API_URL}?action=updateOrder&ids=${ids.join(',')}`); }
        
        function printReport() {
            let html = `<div style="font-family:Sarabun, sans-serif; color:black;"><h2 style="text-align:center;">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô SADAO MED-TECH 2026</h2><p style="text-align:center;">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString()}</p>`;
            Object.keys(CATS).forEach(key => {
                let list = allData.filter(r => r[3] === key);
                if(list.length > 0) {
                    list.sort((a,b) => (b[6]||0) - (a[6]||0));
                    html += `<h3 style="margin-top:20px; border-bottom:2px solid black;">${CATS[key].label}</h3><table style="width:100%; border-collapse:collapse; margin-bottom:10px;"><thead><tr style="background:#eee;"><th style="border:1px solid #ccc; padding:5px;">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th style="border:1px solid #ccc; padding:5px;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th style="border:1px solid #ccc; padding:5px;">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î</th><th style="border:1px solid #ccc; padding:5px;">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th><th style="border:1px solid #ccc; padding:5px; text-align:right;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead><tbody>`;
                    list.forEach((r, idx) => { html += `<tr><td style="border:1px solid #ccc; padding:5px; text-align:center;">${idx+1}</td><td style="border:1px solid #ccc; padding:5px;">${r[1]}</td><td style="border:1px solid #ccc; padding:5px;">${r[2]}</td><td style="border:1px solid #ccc; padding:5px;">${r[4]} (${LEVEL_LABELS[r[7]]||r[7]})</td><td style="border:1px solid #ccc; padding:5px; text-align:right;">${r[6]||0}</td></tr>`; });
                    html += `</tbody></table>`;
                }
            });
            html += `</div>`;
            let printWin = window.open('', '_blank');
            printWin.document.write(`<html><head><title>Print Report</title></head><body>${html}</body></html>`);
            printWin.document.close(); printWin.focus(); setTimeout(() => { printWin.print(); printWin.close(); }, 500);
        }
    </script>
</body>
</html>
