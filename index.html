<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô & ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Sadao 2569)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; padding-bottom: 80px; }
        .header-bg { background: linear-gradient(135deg, #0277bd, #4fc3f7); color: white; padding: 15px 0; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        .card-contestant { border: none; border-radius: 12px; margin-bottom: 12px; background: white; border-left: 6px solid #ccc; position: relative; }
        .card-contestant.active-status { border-left-color: #28a745; background-color: #e8f5e9; }
        
        /* ‡∏õ‡∏∏‡πà‡∏° Admin */
        .top-btn { background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 5px; padding: 5px 10px; cursor: pointer; font-size: 0.9rem; margin-left: 5px; }
        .top-btn:hover { background: rgba(255,255,255,0.4); }

        .drag-handle { cursor: grab; color: #aaa; font-size: 24px; padding: 0 10px; display: none; }
        .admin-mode .drag-handle { display: block; }
        .admin-mode .btn-score { display: none; }
        
        .category-badge { font-size: 0.75rem; background: #e1f5fe; color: #0277bd; padding: 2px 8px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="header-bg text-center">
        <h4 class="fw-bold m-0">üèÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î</h4>
        <small>‡∏Ñ‡∏õ‡∏™‡∏≠.‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏™‡∏∞‡πÄ‡∏î‡∏≤</small>
        <div class="mt-2">
            <button class="top-btn" onclick="addNew()">‚ûï ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
            <button class="top-btn" onclick="toggleAdmin()">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</button>
        </div>
    </div>

    <div class="container" style="max-width: 800px;">
        <div id="contestant-list" class="list-group">
            <div class="text-center py-5"><div class="spinner-border text-primary"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
        </div>
    </div>

    <script>
        // üî¥üî¥ ‡πÉ‡∏™‡πà Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî¥üî¥
        const API_URL = "https://script.google.com/macros/s/AKfycbyGtY1FBwTvk0ng7eOcGJ_cs9mZt-6jC9WoOAWhp1d6YHSTpd3HDJImdae3dFxMvfRv7Q/exec";

        let allData = [];
        let isAdmin = false;
        let sortable = null;

        // ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dropdown
        const CATEGORIES = [
            'Oral Presentation (‡∏ß‡∏¥‡∏à‡∏±‡∏¢/R2R/CQI)',
            'Poster Presentation (‡∏ß‡∏¥‡∏à‡∏±‡∏¢/R2R/‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°)',
            'Photo Voice',
            '‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤ (Storytelling)',
            '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏±‡πâ‡∏ô'
        ];

        const CRITERIA = {
            'Default': [{name:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°', max:100}],
            'Oral': [{name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', max:80}, {name:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', max:20}],
            'Poster': [{name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', max:50}, {name:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', max:50}],
            'Film': [{name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', max:40}, {name:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', max:20}, {name:'‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå', max:20}, {name:'‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', max:20}],
            'Story': [{name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', max:70}, {name:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', max:30}],
            'Photo': [{name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', max:30}, {name:'‡∏†‡∏≤‡∏û', max:50}, {name:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', max:20}]
        };

        window.onload = loadData;

        function loadData() {
            fetch(API_URL + "?action=getContestants")
                .then(res => res.json())
                .then(data => {
                    allData = data;
                    renderList(data);
                });
        }

        function renderList(data) {
            const container = document.getElementById('contestant-list');
            container.innerHTML = '';
            
            data.forEach(row => {
                let id = row[0];
                let name = row[1];
                let category = row[2];
                let org = row[3];
                let status = row[4];

                let html = `
                <div class="card card-contestant p-3 ${status === 'Active' ? 'active-status' : ''}" data-id="${id}">
                    <div class="d-flex align-items-center">
                        <div class="drag-handle">‚ò∞</div>
                        <div class="flex-grow-1 ps-2">
                            ${status === 'Active' ? '<span class="badge bg-success">On Stage</span>' : ''}
                            <h6 class="fw-bold mb-1">${name}</h6>
                            <span class="category-badge">${category}</span> 
                            <small class="text-muted ms-1">üè• ${org}</small>
                        </div>
                        <button class="btn btn-outline-primary btn-sm rounded-pill px-3 btn-score" 
                            onclick="openScore('${id}', '${name}', '${category}')">
                            ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                        </button>
                    </div>
                </div>`;
                container.innerHTML += html;
            });

            if(sortable) sortable.destroy();
            sortable = new Sortable(container, {
                animation: 150, handle: '.drag-handle', disabled: !isAdmin,
                onEnd: () => saveNewOrder()
            });
            updateAdminUI();
        }

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà (Add New) ---
        async function addNew() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropdown ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            let options = "";
            CATEGORIES.forEach(c => options += `<option value="${c}">${c}</option>`);

            const { value: formValues } = await Swal.fire({
                title: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°',
                html:
                    `<input id="swal-name" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏Å‡∏∏‡∏• / ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°">` +
                    `<input id="swal-org" class="swal2-input" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏£‡∏û./‡∏£‡∏û.‡∏™‡∏ï.)">` +
                    `<select id="swal-cat" class="swal2-input">${options}</select>`,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                preConfirm: () => {
                    return {
                        name: document.getElementById('swal-name').value,
                        org: document.getElementById('swal-org').value,
                        cat: document.getElementById('swal-cat').value
                    }
                }
            });

            if (formValues) {
                if(!formValues.name) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠', 'warning');
                
                Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen: () => Swal.showLoading()});
                
                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Backend
                fetch(`${API_URL}?action=addContestant&name=${formValues.name}&category=${formValues.cat}&org=${formValues.org}`)
                    .then(() => {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    })
                    .catch(() => Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'));
            }
        }

        // --- Admin Mode ---
        async function toggleAdmin() {
            if (!isAdmin) {
                const { value: pass } = await Swal.fire({ title: '‡∏£‡∏´‡∏±‡∏™ Admin', input: 'password', inputPlaceholder: '1234' });
                if (pass === '1234') { 
                    isAdmin = true; 
                    updateAdminUI(); 
                    Swal.fire({toast:true, position:'top-end', icon:'success', title:'Admin Mode ON', showConfirmButton:false, timer:1500});
                }
            } else {
                isAdmin = false;
                updateAdminUI();
            }
        }

        function updateAdminUI() {
            const c = document.getElementById('contestant-list');
            if (isAdmin) { c.classList.add('admin-mode'); sortable.option("disabled", false); }
            else { c.classList.remove('admin-mode'); sortable.option("disabled", true); }
        }

        function saveNewOrder() {
            const ids = Array.from(document.querySelectorAll('.card-contestant')).map(el => el.getAttribute('data-id'));
            fetch(API_URL + "?action=updateOrder&ids=" + ids.join(","));
        }

        // --- Scoring (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        async function openScore(id, name, cat) {
            let key = 'Default';
            if (cat.includes('Oral') || cat.includes('R2R')) key = 'Oral';
            else if (cat.includes('Poster')) key = 'Poster';
            else if (cat.includes('Film') || cat.includes('‡∏´‡∏ô‡∏±‡∏á')) key = 'Film';
            else if (cat.includes('Story') || cat.includes('‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤')) key = 'Story';
            else if (cat.includes('Photo')) key = 'Photo';

            let criteria = CRITERIA[key];
            let html = '';
            criteria.forEach((c,i) => {
                html += `<div class="mb-2 text-start"><label>${c.name} (Max ${c.max})</label>
                <input type="number" id="s${i}" class="form-control" max="${c.max}"></div>`;
            });

            let judge = localStorage.getItem('judge') || '';
            if(!judge) {
                let {value:j} = await Swal.fire({title:'‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£', input:'text'});
                if(j) { judge = j; localStorage.setItem('judge', j); } else return;
            }

            let {isConfirmed} = await Swal.fire({ title: name, html: html, showCancelButton:true, confirmButtonText:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' });
            if(isConfirmed) {
                let total=0; let detail=[];
                criteria.forEach((c,i) => {
                    let val = Number(document.getElementById(`s${i}`).value);
                    total += val; detail.push(`${c.name}:${val}`);
                });
                Swal.showLoading();
                fetch(`${API_URL}?action=submitScore&id=${id}&judge=${judge}&score=${total}&detail=${detail.join('|')}`)
                .then(() => Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success'));
            }
        }
    </script>
</body>
</html>
