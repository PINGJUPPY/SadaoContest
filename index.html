<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SADAO MED-TECH 2026</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&family=Orbitron:wght@500;700&family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary: #00f2ff; --secondary: #00ff88; --bg-dark: #050a10;
            --panel-bg: rgba(10, 20, 35, 0.9);
        }
        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 10%, #1a2a44 0%, var(--bg-dark) 70%);
            color: #e0e0e0; min-height: 100vh; padding-bottom: 80px;
        }
        .tech-panel {
            background: var(--panel-bg); border: 1px solid rgba(0,242,255,0.2);
            border-radius: 15px; position: relative; backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .neon-text { color: var(--primary); text-shadow: 0 0 10px rgba(0,242,255,0.5); font-family: 'Orbitron'; }
        .btn-cyber {
            background: rgba(0,242,255,0.1); border: 1px solid var(--primary); color: var(--primary);
            transition: 0.3s; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn-cyber:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); }
        
        .cat-card { cursor: pointer; transition: 0.2s; padding: 20px; text-align: center; height: 100%; border: 1px solid rgba(255,255,255,0.1); }
        .cat-card:hover { border-color: var(--secondary); background: rgba(0,255,136,0.1); transform: translateY(-3px); }
        
        .card-player { border-left: 4px solid #555; margin-bottom: 10px; padding: 15px; background: rgba(255,255,255,0.03); }
        .card-player.active { border-left-color: var(--secondary); background: rgba(0,255,136,0.05); }
        .level-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; margin-left: 5px; }
        .score-mode-switch { cursor: pointer; color: var(--secondary); text-decoration: underline; font-size: 0.9rem; }
        .input-cyber { background: #111; border: 1px solid #444; color: #fff; width: 100%; padding: 8px; }
        
        #login-container { height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #app-container { display: none; }
        .logo-img { max-height: 50px; margin-right: 10px; }

        /* Report Print Style */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; padding: 20px; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="login-container">
        <div class="tech-panel p-5 text-center" style="max-width: 400px; width: 90%;">
            <img src="https://raw.githubusercontent.com/PINGJUPPY/SadaoContest/refs/heads/main/SDH%20LOGO.png" style="max-width:120px; margin-bottom:20px;">
            <h3 class="neon-text mb-4">ACCESS CONTROL</h3>
            <input id="user" class="form-control bg-dark text-light mb-3" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å User">
            <input id="pass" type="password" class="form-control bg-dark text-light mb-3" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Password">
            <button class="btn-cyber w-100" onclick="doLogin()">LOGIN SYSTEM</button>
        </div>
    </div>

    <div id="app-container">
        <nav class="navbar navbar-dark bg-transparent border-bottom border-secondary mb-3 p-3">
            <div class="container">
                <span class="navbar-brand neon-text d-flex align-items-center">
                    <img src="https://raw.githubusercontent.com/PINGJUPPY/SadaoContest/refs/heads/main/SDH%20LOGO.png" class="logo-img">
                    SADAO MED-TECH
                </span>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted d-none d-md-block me-2" id="user-display">JUDGE</small>
                    <button class="btn btn-sm btn-outline-light" onclick="printReport()" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô"><i class="fa-solid fa-print"></i></button>
                    <button class="btn btn-sm btn-outline-danger rounded-circle" onclick="doLogout()"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </nav>

        <div id="admin-toolbar" class="container mb-3 d-none">
            <div class="d-flex justify-content-center gap-2">
                <button class="btn btn-sm btn-outline-info" onclick="addNewContestant()"><i class="fa-solid fa-plus"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                <button class="btn btn-sm btn-outline-warning" onclick="toggleEditMode()"><i class="fa-solid fa-sort"></i> ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</button>
            </div>
        </div>

        <section id="view-dashboard" class="container">
            <h4 class="text-center mb-4 fw-light">SELECT <span style="color:var(--secondary)">CATEGORY</span></h4>
            <div class="row g-3" id="cat-grid"></div>
        </section>

        <section id="view-list" class="container" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-sm btn-outline-light" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i> BACK</button>
                <h5 class="neon-text m-0" id="cat-title">TITLE</h5>
                <div style="width:50px"></div>
            </div>
            <div id="contestant-container"></div>
        </section>

        <section id="view-rank" class="container mt-5 mb-5">
            <div class="tech-panel p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="neon-text m-0"><i class="fa-solid fa-trophy"></i> LEADERBOARD</h5>
                    <select id="rank-level-filter" class="form-select form-select-sm bg-dark text-light w-auto" onchange="updateRank()">
                        <option value="All">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                        <option value="Hospital">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</option>
                        <option value="HPH">‡∏£‡∏û.‡∏™‡∏ï.</option>
                        <option value="DHO">‡∏™‡∏™‡∏≠.</option>
                    </select>
                </div>
                <table class="table table-dark table-sm bg-transparent">
                    <thead><tr class="text-info"><th>#</th><th>TITLE / TEAM</th><th>LEVEL</th><th class="text-end">SCORE</th></tr></thead>
                    <tbody id="rank-body"></tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="print-area" style="display:none;"></div>

    <script>
        // üî¥üî¥ URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî¥üî¥
        const API_URL = "https://script.google.com/macros/s/AKfycbyGtY1FBwTvk0ng7eOcGJ_cs9mZt-6jC9WoOAWhp1d6YHSTpd3HDJImdae3dFxMvfRv7Q/exec";

        const CATS = {
            'Oral_Research': { label: 'Oral: ‡∏ß‡∏¥‡∏à‡∏±‡∏¢', group: 'Oral' },
            'Oral_R2R': { label: 'Oral: R2R', group: 'Oral' },
            'Oral_CQI_Clinic': { label: 'Oral: CQI (Clinic)', group: 'Oral' },
            'Oral_CQI_NonClinic': { label: 'Oral: CQI (Non-Clinic)', group: 'Oral' },
            'Poster_Research': { label: 'Poster: ‡∏ß‡∏¥‡∏à‡∏±‡∏¢', group: 'Poster' },
            'Poster_R2R': { label: 'Poster: R2R', group: 'Poster' },
            'Poster_Innovation': { label: 'Poster: ‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°', group: 'Poster' },
            'Photo_Service': { label: 'Photo: ‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', group: 'Photo' },
            'Photo_Community': { label: 'Photo: ‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô', group: 'Photo' },
            'ShortFilm': { label: '‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏±‡πâ‡∏ô', group: 'Film' }
        };

        const LEVELS = ['Hospital', 'HPH', 'DHO']; 
        const LEVEL_LABELS = {'Hospital':'‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', 'HPH':'‡∏£‡∏û.‡∏™‡∏ï.', 'DHO':'‡∏™‡∏™‡∏≠.'};
        const CRITERIA = {
            'Oral_Research': [ {n:'‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏ó‡∏µ‡πà‡∏°‡∏≤', m:15}, {n:'‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå/‡∏ß‡∏¥‡∏ò‡∏µ', m:15}, {n:'‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠/‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', m:15}, {n:'‡∏ú‡∏•/‡∏≠‡∏†‡∏¥‡∏õ‡∏£‡∏≤‡∏¢/‡∏™‡∏£‡∏∏‡∏õ', m:15}, {n:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û', m:5}, {n:'‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå', m:10}, {n:'‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°', m:5}, {n:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô(80)', m:20} ],
            'Oral_CQI_Clinic': [{n:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤/‡∏ö‡∏ó‡∏Ñ‡∏±‡∏î‡∏¢‡πà‡∏≠', m:80}, {n:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å', m:5}, {n:'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå', m:10}, {n:'‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°', m:5}],
            'Oral_CQI_NonClinic': [{n:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤/‡∏ö‡∏ó‡∏Ñ‡∏±‡∏î‡∏¢‡πà‡∏≠', m:80}, {n:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å', m:5}, {n:'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå', m:10}, {n:'‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°', m:5}],
            'Poster_Research': [{n:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', m:50}, {n:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û', m:15}, {n:'‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö', m:20}, {n:'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå', m:15}], 
            'Poster_R2R': [{n:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', m:50}, {n:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û', m:15}, {n:'‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö', m:20}, {n:'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå', m:15}],
            'Poster_Innovation': [{n:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', m:50}, {n:'‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û', m:10}, {n:'‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö', m:15}, {n:'‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå', m:15}, {n:'‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°', m:10}],
            'Photo_Service': [{n:'‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û/‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', m:30}, {n:'‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏†‡∏≤‡∏û', m:50}, {n:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠/‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°', m:20}],
            'Photo_Community': [{n:'‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û/‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', m:30}, {n:'‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏†‡∏≤‡∏û', m:50}, {n:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠/‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°', m:20}],
            'ShortFilm': [{n:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', m:40}, {n:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', m:20}, {n:'‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ', m:20}, {n:'‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', m:20}],
            'Default': [{n:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°', m:100}]
        };

        let currentUser = null, allData = [], currentCat = '', isEditMode = false, sortableInstance = null, isQuickScore = false;

        window.onload = () => {
            const saved = localStorage.getItem('sadao_user_v2');
            if(saved) { currentUser = JSON.parse(saved); bootSystem(); }
        };

        function doLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            Swal.fire({title:'Checking...', didOpen:()=>Swal.showLoading()});
            fetch(`${API_URL}?action=login&u=${u}&p=${p}`).then(res=>res.json()).then(data=>{
                if(data.status==='success'){ currentUser=data.user; localStorage.setItem('sadao_user_v2',JSON.stringify(currentUser)); bootSystem(); Swal.close(); }
                else Swal.fire('Error','Login Failed','error');
            });
        }
        function doLogout() { localStorage.removeItem('sadao_user_v2'); location.reload(); }
        function bootSystem() {
            document.getElementById('login-container').style.display='none'; document.getElementById('app-container').style.display='block';
            document.getElementById('user-display').innerText = currentUser.name;
            if(currentUser.role==='Admin') document.getElementById('admin-toolbar').classList.remove('d-none');
            fetchData();
        }
        async function fetchData() {
            const res = await fetch(`${API_URL}?action=getData`); allData = await res.json();
            setupDashboard(); updateRank();
        }

        function setupDashboard() {
            const grid = document.getElementById('cat-grid'); grid.innerHTML = '';
            Object.keys(CATS).forEach(key => {
                if(currentUser.role==='Admin' || currentUser.categories.includes(CATS[key].group)) {
                    grid.innerHTML += `<div class="col-6 col-md-4"><div class="tech-panel cat-card" onclick="openCat('${key}')"><h6 class="text-info">${CATS[key].group}</h6><div class="fw-bold">${CATS[key].label}</div></div></div>`;
                }
            });
        }
        function openCat(key) { currentCat=key; document.getElementById('view-dashboard').style.display='none'; document.getElementById('view-list').style.display='block'; document.getElementById('cat-title').innerText=CATS[key].label; renderList(); }
        function goHome() { document.getElementById('view-list').style.display='none'; document.getElementById('view-dashboard').style.display='block'; fetchData(); }

        function renderList() {
            const cont = document.getElementById('contestant-container'); cont.innerHTML='';
            let list = allData.filter(r => r[3] === currentCat); // Col D is Category (index 3)
            if(list.length===0) cont.innerHTML='<div class="text-center text-muted py-5">NO DATA</div>';
            list.forEach(r => {
                let active = r[5] === 'Active'; // Col F is Status (index 5)
                let lvLabel = LEVEL_LABELS[r[7]] || r[7] || '-'; // Col H is Level (index 7)
                cont.innerHTML += `
                <div class="tech-panel card-player ${active?'active':''}" data-id="${r[0]}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="drag-handle me-2 ${isEditMode?'':'d-none'}" style="cursor:move;color:var(--primary)">‚ò∞</div>
                            <div>
                                ${active?'<span class="badge bg-success mb-1">ON STAGE</span>':''}
                                <h6 class="m-0 fw-bold">${r[1]}</h6> <small class="text-muted d-block">${r[2]}</small> <span class="level-badge">${lvLabel}</span> <small class="text-info">${r[4]}</small> </div>
                        </div>
                        <button class="btn btn-sm btn-cyber" onclick="openScore('${r[0]}','${r[1]}')">VOTE</button>
                    </div>
                </div>`;
            });
            if(sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(cont, { handle: '.drag-handle', disabled: !isEditMode, onEnd: saveOrder });
        }

        async function openScore(id, title) {
            let criteriaList = CRITERIA[currentCat] || CRITERIA['Default'];
            let detailHtml = `<div id="detail-area">`;
            criteriaList.forEach((c,i) => {
                detailHtml += `<div class="mb-2 text-start d-flex justify-content-between"><label class="small text-info">${c.n} (${c.m})</label><input type="number" id="sc_${i}" class="input-cyber" style="width:60px" max="${c.m}" onchange="calcTotal()"></div>`;
            });
            detailHtml += `</div>`;
            let quickHtml = `<div id="quick-area" style="display:none"><div class="text-center py-3"><label class="text-warning mb-2">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (‡πÄ‡∏ï‡πá‡∏° 100)</label><input type="number" id="quick_total" class="input-cyber text-center fs-4" max="100"></div></div>`;
            let toggleBtn = `<div class="text-end mb-2"><span class="score-mode-switch" onclick="toggleScoreMode()">‚ö° ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</span></div>`;

            const { isConfirmed } = await Swal.fire({
                title: title,
                html: toggleBtn + detailHtml + quickHtml + `<h5 class="mt-3 text-end text-primary">‡∏£‡∏ß‡∏°: <span id="display-total">0</span></h5>`,
                background: '#0a1423', color: '#fff',
                showCancelButton: true, confirmButtonText: 'CONFIRM', confirmButtonColor: '#00f2ff',
                didOpen: () => { isQuickScore = false; }
            });

            if(isConfirmed) {
                let total = 0, detailStr = "";
                if(isQuickScore) { total = Number(document.getElementById('quick_total').value) || 0; detailStr = "QuickScore"; }
                else { criteriaList.forEach((c,i) => { let v = Number(document.getElementById(`sc_${i}`).value)||0; total += v; detailStr += `[${c.n}:${v}]`; }); }
                Swal.fire({title:'Saving...', didOpen:()=>Swal.showLoading()});
                fetch(`${API_URL}?action=submitScore&id=${id}&judge=${currentUser.name}&score=${total}&detail=${detailStr}`)
                .then(()=>{ Swal.fire('Saved','','success'); fetchData(); });
            }
        }

        window.toggleScoreMode = function() {
            isQuickScore = !isQuickScore;
            document.getElementById('detail-area').style.display = isQuickScore ? 'none' : 'block';
            document.getElementById('quick-area').style.display = isQuickScore ? 'block' : 'none';
            document.querySelector('.score-mode-switch').innerText = isQuickScore ? 'üìù ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠' : '‚ö° ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
            if(isQuickScore) document.getElementById('display-total').innerText = '-'; else window.calcTotal();
        }
        window.calcTotal = function() {
            let sum = 0; document.querySelectorAll('#detail-area input').forEach(inp => sum += Number(inp.value)||0);
            document.getElementById('display-total').innerText = sum;
        }

        function updateRank() {
            const lvFilter = document.getElementById('rank-level-filter').value;
            const tb = document.getElementById('rank-body'); tb.innerHTML = '';
            let sorted = [...allData].filter(r => lvFilter === 'All' || r[7] === lvFilter).sort((a,b)=>(b[6]||0)-(a[6]||0)).slice(0,5);
            sorted.forEach((r,i)=>{
                let lvCode = r[7] || '?';
                tb.innerHTML += `<tr><td><span class="badge bg-dark border border-secondary">${i+1}</span></td><td>${r[1]}<br><small class="text-muted">${r[2]}</small></td><td><small class="text-info">${lvCode}</small></td><td class="text-end fw-bold text-primary">${r[6]||0}</td></tr>`;
            });
        }

        async function addNewContestant() {
            let catOpts = ''; Object.keys(CATS).forEach(k => catOpts += `<option value="${k}">${CATS[k].label}</option>`);
            let lvOpts = ''; LEVELS.forEach(l => lvOpts += `<option value="${l}">${LEVEL_LABELS[l]}</option>`);
            const {value: f} = await Swal.fire({
                title: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', background:'#111', color:'#fff',
                html: `
                    <input id="new-title" class="input-cyber mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°">
                    <input id="new-contestant" class="input-cyber mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î / ‡∏ó‡∏µ‡∏°">
                    <input id="new-org" class="input-cyber mb-2" placeholder="‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î">
                    <select id="new-cat" class="input-cyber mb-2">${catOpts}</select>
                    <select id="new-lv" class="input-cyber mb-2">${lvOpts}</select>
                `,
                preConfirm: () => ({ title: document.getElementById('new-title').value, contestant: document.getElementById('new-contestant').value, org: document.getElementById('new-org').value, cat: document.getElementById('new-cat').value, level: document.getElementById('new-lv').value })
            });
            if(f && f.title) {
                Swal.showLoading();
                fetch(`${API_URL}?action=addContestant&title=${f.title}&contestant=${f.contestant}&org=${f.org}&category=${f.cat}&level=${f.level}`).then(()=>{ Swal.fire('Added'); fetchData(); });
            }
        }
        function toggleEditMode() { isEditMode = !isEditMode; renderList(); }
        function saveOrder() { const ids = Array.from(document.querySelectorAll('.card-player')).map(e=>e.getAttribute('data-id')); fetch(`${API_URL}?action=updateOrder&ids=${ids.join(',')}`); }

        // --- Print Report Function ---
        function printReport() {
            let html = `
            <div style="font-family:Sarabun, sans-serif; color:black;">
                <h2 style="text-align:center;">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô SADAO MED-TECH 2026</h2>
                <p style="text-align:center;">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString()}</p>
            `;
            
            // Loop through each category
            Object.keys(CATS).forEach(key => {
                // Filter data for this category
                let list = allData.filter(r => r[3] === key);
                if(list.length > 0) {
                    // Sort Highest to Lowest Score
                    list.sort((a,b) => (b[6]||0) - (a[6]||0));
                    
                    html += `<h3 style="margin-top:20px; border-bottom:2px solid black;">${CATS[key].label}</h3>`;
                    html += `<table style="width:100%; border-collapse:collapse; margin-bottom:10px;">
                        <thead>
                            <tr style="background:#eee;">
                                <th style="border:1px solid #ccc; padding:5px;">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                <th style="border:1px solid #ccc; padding:5px;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                                <th style="border:1px solid #ccc; padding:5px;">‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏ß‡∏î</th>
                                <th style="border:1px solid #ccc; padding:5px;">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</th>
                                <th style="border:1px solid #ccc; padding:5px; text-align:right;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody>`;
                    
                    list.forEach((r, idx) => {
                        html += `<tr>
                            <td style="border:1px solid #ccc; padding:5px; text-align:center;">${idx+1}</td>
                            <td style="border:1px solid #ccc; padding:5px;">${r[1]}</td>
                            <td style="border:1px solid #ccc; padding:5px;">${r[2]}</td>
                            <td style="border:1px solid #ccc; padding:5px;">${r[4]} (${LEVEL_LABELS[r[7]]||r[7]})</td>
                            <td style="border:1px solid #ccc; padding:5px; text-align:right;">${r[6]||0}</td>
                        </tr>`;
                    });
                    html += `</tbody></table>`;
                }
            });
            html += `</div>`;

            // Open new window to print
            let printWin = window.open('', '_blank');
            printWin.document.write(`<html><head><title>Print Report</title></head><body>${html}</body></html>`);
            printWin.document.close();
            printWin.focus();
            setTimeout(() => { printWin.print(); printWin.close(); }, 500);
        }
    </script>
</body>
</html>
