<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß & ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (Sadao 2569)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; padding-bottom: 80px; }
        .header-bg { background: linear-gradient(135deg, #1565c0, #42a5f5); color: white; padding: 15px 0; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        
        .card-contestant { border: none; border-radius: 12px; margin-bottom: 12px; background: white; border-left: 6px solid #ccc; transition: transform 0.2s; position: relative; }
        .card-contestant.active-status { border-left-color: #28a745; background-color: #e8f5e9; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å */
        .sortable-ghost { opacity: 0.4; background: #c8ebfb; border: 2px dashed #2196f3; }
        .drag-handle { cursor: grab; color: #aaa; font-size: 24px; padding: 0 10px; display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô */
        
        /* ‡πÇ‡∏´‡∏°‡∏î Admin ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö */
        .admin-mode .drag-handle { display: block; }
        .admin-mode .btn-score { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≠‡∏ô‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß */
        
        .admin-toggle { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 5px; padding: 5px 10px; cursor: pointer; }
        .category-badge { font-size: 0.75rem; background: #e3f2fd; color: #0d47a1; padding: 2px 8px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="header-bg text-center">
        <h4 class="fw-bold m-0">üèÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏ß & ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4>
        <small>‡∏Ñ‡∏õ‡∏™‡∏≠.‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏™‡∏∞‡πÄ‡∏î‡∏≤</small>
        <button class="admin-toggle" onclick="toggleAdmin()">‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß</button>
    </div>

    <div class="container" style="max-width: 800px;">
        <div id="contestant-list" class="list-group">
            <div class="text-center py-5"><div class="spinner-border text-primary"></div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
        </div>
    </div>

    <script>
        // üî¥üî¥ ‡πÉ‡∏™‡πà Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üî¥üî¥
        const API_URL = "https://script.google.com/macros/s/AKfycbyGtY1FBwTvk0ng7eOcGJ_cs9mZt-6jC9WoOAWhp1d6YHSTpd3HDJImdae3dFxMvfRv7Q/exec";

        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
        let allData = [];
        let isAdmin = false;
        let sortable = null;

        // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏¢‡πà‡∏≠)
        const CRITERIA = {
            'Default': [{name:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°', max:100}],
            'Oral': [{name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', max:80}, {name:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', max:20}],
            'Poster': [{name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', max:50}, {name:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', max:50}],
            'Film': [{name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', max:40}, {name:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', max:20}, {name:'‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå', max:20}, {name:'‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ', max:20}],
            'Photo': [{name:'‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', max:30}, {name:'‡∏†‡∏≤‡∏û', max:50}, {name:'‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠', max:20}]
        };

        window.onload = loadData;

        function loadData() {
            fetch(API_URL + "?action=getContestants")
                .then(res => res.json())
                .then(data => {
                    allData = data;
                    renderList(data);
                });
        }

        function renderList(data) {
            const container = document.getElementById('contestant-list');
            container.innerHTML = '';
            
            data.forEach(row => {
                let id = row[0];
                let name = row[1];
                let category = row[2];
                let org = row[3];
                let status = row[4];
                let activeClass = (status === 'Active') ? 'active-status' : '';

                // HTML ‡∏Å‡∏≤‡∏£‡πå‡∏î
                let html = `
                <div class="card card-contestant p-3 ${activeClass}" data-id="${id}">
                    <div class="d-flex align-items-center">
                        <div class="drag-handle">‚ò∞</div>
                        
                        <div class="flex-grow-1 ps-2">
                            ${status === 'Active' ? '<span class="badge bg-success">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠</span>' : ''}
                            <h6 class="fw-bold mb-1">${name}</h6>
                            <span class="category-badge">${category}</span> <small class="text-muted ms-1">${org}</small>
                        </div>

                        <button class="btn btn-outline-primary btn-sm rounded-pill px-3 btn-score" 
                            onclick="openScore('${id}', '${name}', '${category}')">
                            ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                        </button>
                    </div>
                </div>`;
                container.innerHTML += html;
            });

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö Drag & Drop (‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Admin)
            if(sortable) sortable.destroy();
            sortable = new Sortable(container, {
                animation: 150,
                handle: '.drag-handle', // ‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏£‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
                disabled: !isAdmin, // ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    saveNewOrder(); // ‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                }
            });
            
            updateAdminUI();
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö Admin / ‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß ---
        async function toggleAdmin() {
            if (!isAdmin) {
                const { value: pass } = await Swal.fire({
                    title: '‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß (Admin)',
                    input: 'password',
                    inputPlaceholder: '‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (1234)',
                    confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'
                });
                if (pass === '1234') { // ‡∏£‡∏´‡∏±‡∏™‡∏á‡πà‡∏≤‡∏¢‡πÜ
                    isAdmin = true;
                    Swal.fire({icon:'success', title:'‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡πâ‡∏ß', text:'‡∏•‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö ‚ò∞ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á', timer: 1500, showConfirmButton:false});
                    updateAdminUI();
                }
            } else {
                isAdmin = false;
                updateAdminUI();
            }
        }

        function updateAdminUI() {
            const container = document.getElementById('contestant-list');
            if (isAdmin) {
                container.classList.add('admin-mode');
                if(sortable) sortable.option("disabled", false); // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å
            } else {
                container.classList.remove('admin-mode');
                if(sortable) sortable.option("disabled", true); // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å
            }
        }

        function saveNewOrder() {
            // ‡∏î‡∏∂‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ID ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            const items = document.querySelectorAll('.card-contestant');
            let newIds = [];
            items.forEach(item => newIds.push(item.getAttribute('data-id')));

            // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà Google Sheet
            const Toast = Swal.mixin({toast: true, position: 'top-end', showConfirmButton: false, timer: 2000});
            Toast.fire({icon: 'info', title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö...'});

            fetch(API_URL + "?action=updateOrder&ids=" + newIds.join(","))
                .then(res => res.text())
                .then(msg => Toast.fire({icon: 'success', title: '‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'}))
                .catch(err => Toast.fire({icon: 'error', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'}));
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        async function openScore(id, name, cat) {
            let key = 'Default';
            if (cat.includes('Oral') || cat.includes('R2R')) key = 'Oral';
            else if (cat.includes('Poster')) key = 'Poster';
            else if (cat.includes('Film') || cat.includes('‡∏´‡∏ô‡∏±‡∏á')) key = 'Film';
            else if (cat.includes('Photo')) key = 'Photo';

            let criteria = CRITERIA[key];
            let html = '';
            criteria.forEach((c,i) => {
                html += `<div class="mb-2 text-start"><label>${c.name} (Max ${c.max})</label>
                <input type="number" id="s${i}" class="form-control" max="${c.max}"></div>`;
            });

            // ‡∏ñ‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£
            let judge = localStorage.getItem('judge') || '';
            if(!judge) {
                let {value:j} = await Swal.fire({title:'‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£', input:'text'});
                if(j) { judge = j; localStorage.setItem('judge', j); } else return;
            }

            let {isConfirmed} = await Swal.fire({
                title: name, html: html, showCancelButton:true, confirmButtonText:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'
            });

            if(isConfirmed) {
                let total=0; 
                let detail=[];
                criteria.forEach((c,i) => {
                    let val = Number(document.getElementById(`s${i}`).value);
                    total += val;
                    detail.push(`${c.name}:${val}`);
                });
                
                Swal.showLoading();
                fetch(`${API_URL}?action=submitScore&id=${id}&judge=${judge}&score=${total}&detail=${detail.join('|')}`)
                .then(() => Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '', 'success'));
            }
        }
    </script>
</body>
</html>
